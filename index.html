<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Life Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
    :root {
    /* Color Palette */
    --primary-color: #6a11cb; /* Deep Purple */
    --secondary-color: #2575fc; /* Bright Blue */
    --accent-color: #00d4ff; /* Cyan */
    --background-color: #1a1a2e; /* Dark Blue/Purple */
    --card-bg-color: #2e2e4a; /* Slightly lighter dark blue */
    --text-color: #e0e0e0; /* Light Gray */
    --text-color-light: #ffffff; /* White */
    --border-color: #4a4a6b; /* Muted Purple */
    --hover-color: #4f039c; /* Darker primary for hover */
    --gradient-start: #3a005c; /* Darker purple for gradients */
    --gradient-end: #0f0f1d; /* Very dark blue for gradients */

    /* Rarities */
    --rarity-common: #888888; /* Gray */
    --rarity-uncommon: #4CAF50; /* Green */
    --rarity-rare: #2196F3; /* Blue */
    --rarity-legendary: #FF9800; /* Orange */
    --rarity-mythic: #F44336; /* Red */
    --rarity-divine: #9C27B0; /* Deep Purple */
    --rarity-exclusive: #FFD700; /* Gold */
    --rarity-starter: #673AB7; /* Indigo */

    /* Rainbow Variant specific colors (subtle gradient) */
    --rainbow-start: #ff7e5f;
    --rainbow-end: #feb47b;
}

/* Base Styles & Reset */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Roboto', sans-serif;
    background: linear-gradient(135deg, var(--background-color), var(--gradient-end));
    color: var(--text-color);
    line-height: 1.6;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow-x: hidden; /* Prevent horizontal scroll */
}

header {
    background: var(--primary-color);
    color: var(--text-color-light);
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    margin-bottom: 20px;
    position: sticky;
    top: 0;
    z-index: 1000; /* Ensure header stays on top */
}

header h1 {
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    font-size: 2.8em;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
    letter-spacing: 1px;
}

.main-layout-wrapper {
    display: flex;
    flex-grow: 1; /* Allow main content to take available space */
    width: 100%;
    max-width: 1400px; /* Max width for content */
    margin: 20px auto;
    padding: 0 20px;
    gap: 30px; /* Space between sidebar and main content */
}

/* Sidebar */
.sidebar {
    flex: 0 0 280px; /* Fixed width sidebar */
    background: var(--card-bg-color);
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 25px;
    position: sticky; /* Sticky sidebar */
    top: calc(20px + 60px); /* Adjust based on header height + margin */
    align-self: flex-start; /* Align to the top of its container */
    max-height: calc(100vh - 40px - 60px); /* Max height for scrolling */
    overflow-y: auto; /* Enable scrolling for content */
}

.sidebar::-webkit-scrollbar {
    width: 8px;
}

.sidebar::-webkit-scrollbar-track {
    background: #3a3a5a;
    border-radius: 10px;
}

.sidebar::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 10px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
    background: var(--hover-color);
}

.content-area {
    flex-grow: 1; /* Main content takes remaining space */
    display: flex;
    flex-direction: column;
    gap: 25px;
}

section {
    background: var(--card-bg-color);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    animation: fadeIn 0.8s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

h2 {
    font-family: 'Montserrat', sans-serif;
    color: var(--accent-color);
    margin-bottom: 20px;
    text-align: center;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 10px;
    font-size: 2em;
    position: relative; /* For decorative elements */
}

h2::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 4px;
    background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
    border-radius: 2px;
}

/* Global Boosts */
.global-boosts {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 30px;
}

.boost-item {
    background: linear-gradient(135deg, #3a3a5a, #4a4a6b);
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3), 0 2px 5px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: bold;
    color: var(--text-color-light);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.boost-item:hover {
    transform: translateY(-3px);
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.4), 0 6px 15px rgba(0, 0, 0, 0.3);
}

.boost-item label {
    margin-right: 5px;
    white-space: nowrap;
}

.boost-item input[type="number"],
.boost-item input[type="checkbox"] {
    transform: scale(1.2);
    margin-right: 5px;
    accent-color: var(--accent-color); /* Style checkbox itself */
}

.boost-info {
    font-size: 1em;
    color: var(--accent-color);
    display: flex;
    align-items: center;
    gap: 5px;
}

.boost-info i {
    font-size: 1.2em;
    color: var(--secondary-color);
}

#premiumStatusDisplay.active {
    color: var(--rarity-exclusive); /* Gold color for active premium */
}

#premiumStatusDisplay.inactive {
    color: var(--rarity-common); /* Gray for inactive */
}

/* Managers and Variants (in Sidebar) */
.selection-section h2 {
    font-size: 1.8em;
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 15px;
}

#managers-list,
#variants-list {
    display: flex;
    flex-direction: column; /* Stack vertically */
    gap: 12px;
}

.manager, .variant {
    background: linear-gradient(90deg, #3a3a5a, #4a4a6b);
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid transparent;
    font-weight: 500;
    text-align: center;
    font-size: 1.1em;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.manager:hover, .variant:hover {
    background: var(--hover-color);
    border-color: var(--accent-color);
    transform: scale(1.02);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
}

.manager.selected, .variant.selected {
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    border-color: var(--accent-color);
    box-shadow: 0 0 18px rgba(0, 212, 255, 0.8); /* Stronger glow */
    transform: scale(1.05);
    font-weight: 700;
    color: var(--text-color-light);
}

/* Variant specific classes (subtle gradients) */
.variant.base { background: linear-gradient(90deg, #8c8c8c, #a0a0a0); }
.variant.gold { background: linear-gradient(90deg, #daa520, #e0b63c); }
.variant.rainbow { background: linear-gradient(90deg, var(--rainbow-start), var(--rainbow-end)); color: #333; } /* Lighter text for rainbow */
.variant.inferno { background: linear-gradient(90deg, #a00000, #b00000); }
.variant.oblivion { background: linear-gradient(90deg, #330033, #440044); color: #ff00ff; }
.variant.celestial { background: linear-gradient(90deg, #000080, #000099); color: #add8e6; }


/* Filters, Sort, Search */
.filters-sort-search {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 25px;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #2a2a42, #3a3a5a);
    border-radius: 12px;
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
}

.filter-group {
    display: flex;
    flex-direction: column; /* Stack label and input */
    align-items: flex-start;
    gap: 8px;
}

.filter-group label {
    font-weight: 600;
    white-space: nowrap;
    color: var(--accent-color);
    font-size: 1em;
}

.filters-sort-search select,
.filters-sort-search input[type="text"] {
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: #3a3a5a;
    color: var(--text-color-light);
    font-size: 1em;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13%205.7L146.2%20208.8%2018.6%2075.1c-6.7-6.7-17.6-6.7-24.2%200-6.8%206.7-6.8%2017.7%200%2024.4l137.2%20137.2c6.7%206.7%2017.6%206.7%2024.2%200l137.2-137.2c6.7-6.8%206.7-17.7%200-24.4z%22%2F%3E%3C%2Fsvg%3E');
    background-repeat: no-repeat;
    background-position: right 12px top 50%;
    background-size: 15px auto;
    padding-right: 40px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
}

.filters-sort-search input[type="text"]::placeholder {
    color: #b0b0b0;
}

/* Rarity Checkbox Group */
.rarity-checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    background-color: #3a3a5a; /* A specific background for the checkboxes */
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #4a4a6b;
}

.rarity-checkbox-item {
    display: flex;
    align-items: center;
    background-color: #4a4a6b;
    padding: 8px 15px;
    border-radius: 25px;
    cursor: pointer;
    transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    border: 1px solid transparent;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.rarity-checkbox-item:hover {
    background-color: var(--hover-color);
    transform: translateY(-1px);
}

.rarity-checkbox-item.selected {
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    box-shadow: 0 0 12px rgba(0, 212, 255, 0.6);
    border-color: var(--accent-color);
    transform: scale(1.02);
}

.rarity-checkbox-item input[type="checkbox"] {
    margin-right: 8px;
    accent-color: var(--accent-color);
    transform: scale(1.1);
}

.rarity-checkbox-item label {
    font-size: 0.95em;
    font-weight: 500;
    cursor: pointer;
    color: var(--text-color-light);
}

/* Structures Grid */
.structures-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 25px;
}

.structure {
    background: linear-gradient(135deg, #3a3a5a, #4a4a6b);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    text-align: center;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    border: 2px solid transparent;
    position: relative;
    overflow: hidden; /* For gradient border effect */
}

.structure::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 12px;
    padding: 2px; /* controls the border thickness */
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color), var(--accent-color));
    -webkit-mask:
        linear-gradient(#fff 0 0) content-box,
        linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    z-index: -1;
    opacity: 0;
    transition: opacity 0.3s ease;
}


.structure:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 25px rgba(0, 0, 0, 0.5);
}

.structure.selected {
    border-color: var(--accent-color); /* Fallback */
    box-shadow: 0 0 25px rgba(0, 212, 255, 0.9);
    background: linear-gradient(135deg, var(--primary-color), var(--hover-color));
}

.structure.selected::before {
    opacity: 1; /* Show gradient border when selected */
}

.structure h3 {
    font-family: 'Montserrat', sans-serif;
    color: var(--text-color-light);
    margin-bottom: 10px;
    font-size: 1.4em;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
}

.structure p {
    font-size: 1em;
    margin-bottom: 6px;
    color: var(--text-color);
}

.structure p:last-child {
    font-weight: bold;
    color: var(--accent-color);
    font-size: 1.2em;
    margin-top: 10px;
}

/* Rarity classes for structure cards */
.rarity {
    font-size: 0.85em;
    padding: 4px 10px;
    border-radius: 20px;
    display: inline-block;
    margin-bottom: 8px;
    font-weight: bold;
    text-transform: uppercase;
    color: #fff;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2), 0 1px 3px rgba(0, 0, 0, 0.1);
    letter-spacing: 0.5px;
}

.rarity.common { background-color: var(--rarity-common); }
.rarity.uncommon { background-color: var(--rarity-uncommon); }
.rarity.rare { background-color: var(--rarity-rare); }
.rarity.legendary { background-color: var(--rarity-legendary); }
.rarity.mythic { background-color: var(--rarity-mythic); }
.rarity.divine { background-color: var(--rarity-divine); }
.rarity.exclusive { background-color: var(--rarity-exclusive); color: #333; } /* Gold text for exclusive */
.rarity.starter { background-color: var(--rarity-starter); }


/* Wiki Section */
.wiki-box {
    background: linear-gradient(135deg, #3a3a5a, #4a4a6b);
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    min-height: 220px;
    display: flex;
    flex-direction: column;
    justify-content: center; /* Center content vertically */
    align-items: center; /* Center content horizontally */
    text-align: center;
}

.wiki-box h3 {
    font-family: 'Montserrat', sans-serif;
    color: var(--accent-color);
    margin-bottom: 18px;
    font-size: 2em;
    text-align: center;
    text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.4);
}

.wiki-box p {
    margin-bottom: 10px;
    font-size: 1.15em;
    color: var(--text-color);
    max-width: 90%; /* Limit line length for readability */
}

.wiki-box strong {
    color: var(--text-color-light);
    font-weight: 700;
}

/* Trade Section */
.trade-panels-container {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
    justify-content: center;
    margin-bottom: 30px;
}

.trade-panel {
    flex: 1;
    min-width: 320px;
    max-width: 580px;
    background: linear-gradient(135deg, #3a3a5a, #4a4a6b);
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
}

.trade-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at top left, rgba(0, 212, 255, 0.1), transparent 50%),
                radial-gradient(circle at bottom right, rgba(106, 17, 203, 0.1), transparent 50%);
    z-index: 0;
    pointer-events: none;
}

.trade-panel h3 {
    font-family: 'Montserrat', sans-serif;
    color: var(--accent-color);
    margin-bottom: 25px;
    font-size: 1.8em;
    text-align: center;
    position: relative;
    z-index: 1;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
}

.trade-controls {
    display: grid;
    grid-template-columns: 1fr 2fr; /* Labels and inputs */
    gap: 15px 20px;
    margin-bottom: 25px;
    align-items: center;
    position: relative;
    z-index: 1;
}

.trade-controls label {
    font-weight: 600;
    white-space: nowrap;
    color: var(--text-color-light);
    font-size: 1em;
}

.trade-controls select {
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: #4a4a6b;
    color: var(--text-color-light);
    font-size: 1em;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13%205.7L146.2%20208.8%2018.6%2075.1c-6.7-6.7-17.6-6.7-24.2%200-6.8%206.7-6.8%2017.7%200%2024.4l137.2%20137.2c6.7%206.7%2017.6%206.7%2024.2%200l137.2-137.2c6.7-6.8%206.7-17.7%200-24.4z%22%2F%3E%3C%2Fsvg%3E');
    background-repeat: no-repeat;
    background-position: right 12px top 50%;
    background-size: 15px auto;
    padding-right: 40px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
}

.trade-controls button {
    grid-column: span 2; /* Span across both columns */
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1em;
    font-weight: bold;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.trade-controls .add-btn {
    background-color: var(--secondary-color);
    color: var(--text-color-light);
}

.trade-controls .add-btn:hover {
    background-color: #1e5bbd;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
}

.trade-controls .clear-btn {
    background-color: #dc3545; /* Red for clear */
    color: var(--text-color-light);
}

.trade-controls .clear-btn:hover {
    background-color: #c82333;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
}

.structures-trade-list {
    background: #2a2a42;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    min-height: 120px; /* Slightly larger min-height */
    max-height: 280px; /* Slightly larger max-height */
    overflow-y: auto;
    margin-bottom: 15px;
    position: relative;
    z-index: 1;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
}

.structures-trade-list::-webkit-scrollbar {
    width: 6px;
}

.structures-trade-list::-webkit-scrollbar-track {
    background: #3a3a5a;
    border-radius: 10px;
}

.structures-trade-list::-webkit-scrollbar-thumb {
    background: var(--secondary-color);
    border-radius: 10px;
}

.structures-trade-list::-webkit-scrollbar-thumb:hover {
    background: #007bff;
}


.structure-item {
    background: #4a4a6b;
    padding: 10px 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1em;
    color: var(--text-color-light);
    transition: background-color 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.structure-item:last-child {
    margin-bottom: 0;
}

.structure-item.removing {
    opacity: 0;
    transform: translateX(-30px);
}

.structure-item button {
    background: none;
    border: none;
    color: #ff6347; /* Tomato */
    font-size: 1.6em;
    cursor: pointer;
    transition: color 0.2s ease, transform 0.2s ease;
    padding: 0 5px; /* Add some padding for easier click */
}

.structure-item button:hover {
    color: #ff0000;
    transform: scale(1.3);
}

.total-mps-display {
    font-weight: bold;
    color: var(--accent-color);
    text-align: center;
    margin-top: 15px;
    font-size: 1.3em;
    padding: 8px;
    background: #2a2a42;
    border-radius: 8px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
}

.calculate-btn {
    display: block;
    width: fit-content;
    margin: 30px auto;
    padding: 18px 35px;
    font-size: 1.5em;
    font-weight: bold;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    color: var(--text-color-light);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    position: relative;
    overflow: hidden;
}

.calculate-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.15);
    transform: skewX(-30deg);
    transition: all 0.5s ease;
}

.calculate-btn:hover::before {
    left: 100%;
}

.calculate-btn:hover {
    transform: translateY(-7px) scale(1.03);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
    filter: brightness(1.15);
}

.result-box {
    background: linear-gradient(135deg, #2a2a42, #3a3a5a);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 25px;
    white-space: pre-wrap; /* Preserve newlines */
    font-family: 'Roboto Mono', monospace; /* Monospace for results */
    font-size: 1.05em;
    color: var(--text-color-light);
    margin-top: 25px;
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
    max-height: 450px; /* Increased max height */
    overflow-y: auto;
    position: relative;
    z-index: 1;
}

.result-box::-webkit-scrollbar {
    width: 8px;
}

.result-box::-webkit-scrollbar-track {
    background: #3a3a5a;
    border-radius: 10px;
}

.result-box::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 10px;
}

.result-box::-webkit-scrollbar-thumb:hover {
    background: var(--hover-color);
}

/* Chart Styles */
.trade-chart-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 300px; /* Increased height for chart */
    background: linear-gradient(135deg, #2a2a42, #3a3a5a);
    border-radius: 12px;
    padding: 25px;
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
    margin-top: 25px;
    display: none; /* Hidden by default, shown when calculateTrades() is called */
    position: relative;
    z-index: 1;
}

.chart-bars {
    display: flex;
    align-items: flex-end;
    gap: 40px; /* Increased gap between bars */
    height: 85%; /* Bars take more height */
    width: 100%;
    max-width: 350px; /* Wider chart */
    border-bottom: 3px solid var(--border-color);
    padding-bottom: 10px;
    position: relative;
}

.chart-bar {
    width: 90px; /* Wider bars */
    background: linear-gradient(to top, var(--primary-color), var(--secondary-color));
    border-radius: 10px 10px 0 0;
    position: relative;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    transition: height 0.6s ease-out, background 0.3s ease; /* Smoother transition */
    box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255,255,255,0.1); /* Subtle white border */
}

.chart-bar.trade1 { background: linear-gradient(to top, #007bff, #00c6ff); } /* Blue gradient */
.chart-bar.trade2 { background: linear-gradient(to top, #ff416c, #ff4b2b); } /* Red/Orange gradient */


.bar-value {
    position: absolute;
    top: -30px;
    font-size: 1em;
    font-weight: bold;
    color: var(--text-color-light);
    white-space: nowrap;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
}

.chart-labels {
    display: flex;
    justify-content: space-around;
    width: 100%;
    max-width: 350px;
    margin-top: 15px;
    font-weight: bold;
    color: var(--text-color-light);
    gap: 40px;
}
.chart-labels span {
    flex: 1;
    text-align: center;
    color: var(--accent-color);
    font-size: 1.1em;
}


/* Footer */
footer {
    text-align: center;
    padding: 20px;
    margin-top: 30px;
    background: #1a1a2e;
    color: #909090;
    font-size: 0.9em;
    border-top: 1px solid #2e2e4a;
    box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.4);
}

/* Responsive adjustments */
@media (max-width: 1024px) {
    .main-layout-wrapper {
        flex-direction: column; /* Stack sidebar and content */
        margin: 15px auto;
        padding: 0 15px;
        gap: 25px;
    }

    .sidebar {
        position: relative; /* No longer sticky */
        top: auto;
        max-height: none; /* No max height, content flows */
        flex: auto; /* Allow sidebar to take natural height */
    }

    .selection-section h2 {
        text-align: center;
    }

    .selection-section {
        flex-direction: column; /* Stack managers and variants */
        align-items: stretch;
    }

    .filters-sort-search {
        flex-direction: column;
        align-items: stretch;
    }

    .filter-group {
        flex-direction: column;
        align-items: flex-start;
    }

    .filters-sort-search select,
    .filters-sort-search input[type="text"] {
        width: 100%;
    }

    .trade-panels-container {
        flex-direction: column;
        align-items: stretch;
    }

    .trade-panel {
        max-width: 100%;
    }

    .trade-controls {
        grid-template-columns: 1fr; /* Single column for controls */
    }
    .trade-controls button {
        grid-column: span 1;
    }
}

@media (max-width: 768px) {
    header h1 {
        font-size: 2.2em;
    }
    section {
        padding: 20px;
    }
    h2 {
        font-size: 1.8em;
    }
    .structure {
        min-width: 180px;
    }
    .wiki-box p {
        font-size: 1em;
    }
}

@media (max-width: 480px) {
    header h1 {
        font-size: 1.8em;
    }
    .container {
        padding: 0 10px;
    }
    .boost-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
        padding: 10px 15px;
    }
    .structure {
        min-width: 140px; /* Smaller cards for tiny screens */
        padding: 15px;
    }
    .filters-sort-search {
        padding: 15px;
        gap: 15px;
    }
    .rarity-checkbox-item {
        padding: 6px 12px;
    }
    .trade-panel {
        padding: 20px;
    }
    .trade-controls button {
        padding: 10px 15px;
        font-size: 1em;
    }
    .calculate-btn {
        padding: 15px 25px;
        font-size: 1.2em;
    }
    .result-box {
        padding: 15px;
        font-size: 0.95em;
    }
    .chart-bar {
        width: 70px;
        gap: 20px;
    }
    .chart-labels {
        gap: 20px;
    }
}
    </style>
</head>
<body>
    <header>
        <h1>Idle Life Calculator</h1>
    </header>

    <div class="main-layout-wrapper">
        <aside class="sidebar">
            <section class="selection-section">
                <h2>Variants</h2>
                <div id="variants-list"></div>
            </section>
            <section class="selection-section">
                <h2>Managers</h2>
                <div id="managers-list"></div>
            </section>
        </aside>

        <main class="content-area">
            <section class="config-section">
                <h2>Global Configuration</h2>
                <div class="global-boosts">
                    <div class="boost-item">
                        <label for="friendsCount">Online Friends (Max 5):</label>
                        <input type="number" id="friendsCount" value="0" min="0" max="5">
                        <span id="onlineFriendsPercentageDisplay" class="boost-info"><i class="fas fa-users"></i> +0%</span>
                    </div>
                    <div class="boost-item">
                        <label for="isPremium">Premium Account:</label>
                        <input type="checkbox" id="isPremium">
                        <span id="premiumStatusDisplay" class="boost-info inactive"><i class="fas fa-crown"></i> Inactive</span>
                    </div>
                </div>
            </section>

            <section class="structures-section">
                <h2>Available Structures</h2>
                <div class="filters-sort-search">
                    <div class="filter-group">
                        <label for="sortOrder">Sort by:</label>
                        <select id="sortOrder">
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="mps-desc">MPS (Max-Min)</option>
                            <option value="mps-asc">MPS (Min-Max)</option>
                            <option value="price-asc">Price (Min-Max)</option>
                            <option value="price-desc">Price (Max-Min)</option>
                        </select>
                    </div>
                    <div class="filter-group rarity-filters-container">
                        <label>Filter by Rarity:</label>
                        <div id="rarityFilter" class="rarity-checkbox-group"></div>
                    </div>
                    <div class="filter-group search-group">
                        <label for="searchStructures">Search Structure:</label>
                        <input type="text" id="searchStructures" placeholder="Structure name...">
                    </div>
                </div>
                <div id="structures-container" class="structures-grid"></div>
            </section>

            <section class="wiki-section">
                <div id="wiki-text" class="wiki-box">
                    <h3>Idle Life Wiki</h3>
                    <p>Select a structure from the list above to view detailed information,
                    calculated with the currently selected Variant, Manager, and global boosts.</p>
                </div>
            </section>

            <section class="trade-section">
                <h2>Trade Comparison</h2>
                <div class="trade-panels-container">
                    <div class="trade-panel">
                        <h3>Trade 1</h3>
                        <div class="trade-controls">
                            <label for="tradeVariant1">Variant:</label>
                            <select id="tradeVariant1"></select>
                            <label for="tradeManager1">Manager:</label>
                            <select id="tradeManager1"></select>
                            <label for="tradeStructureSelect1">Add Structure:</label>
                            <select id="tradeStructureSelect1"></select>
                            <button onclick="addTradeStructure(1)" class="add-btn">Add</button>
                            <button onclick="clearTradeStructures(1)" class="clear-btn">Clear</button>
                        </div>
                        <div id="structuresList1" class="structures-trade-list"></div>
                        <p id="trade1TotalMps" class="total-mps-display">Total MPS: $0</p>
                    </div>

                    <div class="trade-panel">
                        <h3>Trade 2</h3>
                        <div class="trade-controls">
                            <label for="tradeVariant2">Variant:</label>
                            <select id="tradeVariant2"></select>
                            <label for="tradeManager2">Manager:</label>
                            <select id="tradeManager2"></select>
                            <label for="tradeStructureSelect2">Add Structure:</label>
                            <select id="tradeStructureSelect2"></select>
                            <button onclick="addTradeStructure(2)" class="add-btn">Add</button>
                            <button onclick="clearTradeStructures(2)" class="clear-btn">Clear</button>
                        </div>
                        <div id="structuresList2" class="structures-trade-list"></div>
                        <p id="trade2TotalMps" class="total-mps-display">Total MPS: $0</p>
                    </div>
                </div>

                <button onclick="calculateTrades()" class="calculate-btn">Compare Trades!</button>

                <div id="tradeChartContainer" class="trade-chart-container">
                    <div id="chartBars" class="chart-bars"></div>
                    <div class="chart-labels">
                        <span>Trade 1</span>
                        <span>Trade 2</span>
                    </div>
                </div>
                <pre id="resultBox" class="result-box"></pre>
            </section>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 Idle Life Calculator</p>
    </footer>
        <script>
    // Define the multipliers object here
    const multipliers = {
        Base: 1, Gold: 1.5, Rainbow: 2.0,
        Inferno: 3, Oblivion: 4.0, Celestial: 5.0
    };

    const variantClasses = {
        Base: "base", Gold: "gold", Rainbow: "rainbow",
        Inferno: "inferno", Oblivion: "oblivion", Celestial: "celestial"
    };
    const variants = Object.keys(multipliers).map(name => ({ name, multiplier: multipliers[name] }));

    const managers = [
        { name: "Base Manager", multiplier: 1 },
        { name: "Clown Manager", multiplier: 1.2 },
        { name: "Soldier Manager", multiplier: 1.4 },
        { name: "Mayor Manager", multiplier: 1.6 },
        { name: "King Manager", multiplier: 2.0 },
        { name: "Modern Manager", multiplier: 2.4 },
        { name: "Angel Manager", multiplier: 3 },
    ];

    const structuresData = [
        { name: "Noob", income: 1, cycleTime: 4, rarity: "common", price: 30 },
        { name: "Business Man", income: 5, cycleTime: 4, rarity: "common", price: 200 },
        { name: "Builder", income: 10, cycleTime: 4, rarity: "starter", price: 0 },
        { name: "Teacher", income: 10, cycleTime: 5, rarity: "common", price: 500 },
        { name: "Gardener", income: 20, cycleTime: 8, rarity: "uncommon", price: 1200 },
        { name: "Painter", income: 75, cycleTime: 10, rarity: "uncommon", price: 3500 },
        { name: "Chef", income: 105, cycleTime: 10, rarity: "uncommon", price: 8000 },
        { name: "Mine", income: 189, cycleTime: 12, rarity: "rare", price: 15000 },
        { name: "Fortune Magician", income: 450, cycleTime: 15, rarity: "rare", price: 45000 },
        { name: "Bank", income: 1500, cycleTime: 20, rarity: "legendary", price: 200000 },
        { name: "Skyscraper", income: 4500, cycleTime: 30, rarity: "legendary", price: 750000 },
        { name: "Stadium", income: 14000, cycleTime: 35, rarity: "mythic", price: 2500000 },
        { name: "Waterpark", income: 50000, cycleTime: 45, rarity: "mythic", price: 10000000 },
        { name: "Castle", income: 250000, cycleTime: 40, rarity: "mythic", price: 150000000 },
        { name: "Club", income: 600000, cycleTime: 60, rarity: "Divine", price: 1000000000 },
        { name: "Airport", income: 2880000, cycleTime: 60, rarity: "Divine", price: 12000000000 },
        { name: "Astronaut", income: 1000, cycleTime: 8, rarity: "Exclusive", price: 0 },
        { name: "Alien Gardener", income: 1800, cycleTime: 10, rarity: "Exclusive", price: 0 },
        { name: "Ufo", income: 10000, cycleTime: 20, rarity: "Exclusive", price: 0 },
        { name: "Black Hole", income: 100000, cycleTime: 25, rarity: "Exclusive", price: 0 },
        { name: "Galaxy", income: 200000, cycleTime: 10, rarity: "Exclusive", price: 0 },
    ];

    // State variables
    let selectedVariant = variants[0];
    let selectedManager = managers[0];
    let selectedStructureIndex = null;

    const tradeStates = {
        1: {
            variant: variants[0],
            manager: managers[0],
            structures: []
        },
        2: {
            variant: variants[0],
            manager: managers[0],
            structures: []
        }
    };

    let currentRarityFilter = []; // Stores selected rarity names
    let currentSortOrder = 'name-asc';
    let currentSearchQuery = '';

    let globalFriendsBoostMultiplier = 1;
    let globalPremiumMultiplier = 1;

    const MAX_FRIENDS_FOR_BOOST = 5;
    const FRIEND_BONUS_PER_FRIEND = 0.05;
    const PREMIUM_BONUS_MULTIPLIER = 1.10;

    // --- Core Functions ---

    function formatMoney(amount) {
        if (amount === undefined || amount === null || isNaN(amount)) return "$0";
        if (amount >= 1e12) return "$" + (amount / 1e12).toFixed(2) + "T";
        if (amount >= 1e9) return "$" + (amount / 1e9).toFixed(2) + "B";
        if (amount >= 1e6) return "$" + (amount / 1e6).toFixed(2) + "M";
        if (amount >= 1e3) return "$" + (amount / 1e3).toFixed(1) + "K";
        return "$" + amount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function updateGlobalBoosts() {
        const friendsCountInput = document.getElementById('friendsCount');
        const friendsCount = parseInt(friendsCountInput.value) || 0;
        const isPremiumActive = document.getElementById('isPremium').checked;

        let actualFriendsCount = Math.min(Math.max(0, friendsCount), MAX_FRIENDS_FOR_BOOST);

        globalFriendsBoostMultiplier = 1 + (actualFriendsCount * FRIEND_BONUS_PER_FRIEND);
        document.getElementById('onlineFriendsPercentageDisplay').innerHTML = `<i class="fas fa-users"></i> +${(actualFriendsCount * FRIEND_BONUS_PER_FRIEND * 100).toFixed(0)}%`;

        globalPremiumMultiplier = isPremiumActive ? PREMIUM_BONUS_MULTIPLIER : 1;

        const premiumStatusElement = document.getElementById('premiumStatusDisplay');
        premiumStatusElement.innerHTML = `<i class="fas fa-crown"></i> ${isPremiumActive ? `Active (x${PREMIUM_BONUS_MULTIPLIER.toFixed(2)})` : 'Inactive'}`;
        premiumStatusElement.classList.toggle('active', isPremiumActive);
        premiumStatusElement.classList.toggle('inactive', !isPremiumActive);

        renderStructures();
        updateWiki();
        // Recalculate trade lists to reflect current global boosts *if* trade items are added
        // (The individual trade items' boosts are captured, but the overall display might need a refresh)
        updateTradeStructureList(1);
        updateTradeStructureList(2);
    }

    function renderManagers() {
        const container = document.getElementById("managers-list");
        container.innerHTML = ''; // Clears only the manager items, not the H2
        managers.forEach((mgr) => {
            const div = document.createElement("div");
            div.className = "manager";
            if (mgr === selectedManager) div.classList.add("selected");
            div.textContent = `${mgr.name}: x${mgr.multiplier}`;
            div.addEventListener("click", () => {
                selectedManager = mgr;
                document.querySelectorAll(".manager").forEach(el => el.classList.remove("selected"));
                div.classList.add("selected");
                updateWiki();
                renderStructures();
            });
            container.appendChild(div);
        });
    }

    function renderVariants() {
        const container = document.getElementById("variants-list");
        container.innerHTML = ''; // Clears only the variant items, not the H2
        variants.forEach((variant) => {
            const div = document.createElement("div");
            div.className = `variant ${variantClasses[variant.name]}`;
            if (variant === selectedVariant) div.classList.add("selected");
            div.textContent = variant.name;
            div.addEventListener("click", () => {
                selectedVariant = variant;
                document.querySelectorAll(".variant").forEach(el => el.classList.remove("selected"));
                div.classList.add("selected");
                updateWiki();
                renderStructures();
            });
            container.appendChild(div);
        });
    }

    function renderRarityFilters() {
        const container = document.getElementById('rarityFilter');
        container.innerHTML = ''; // Clear previous checkboxes

        const uniqueRarities = Array.from(new Set(structuresData.map(s => s.rarity.toLowerCase())));
        uniqueRarities.sort();

        // Add 'All' option
        const allCheckboxDiv = document.createElement('div');
        allCheckboxDiv.className = 'rarity-checkbox-item';
        allCheckboxDiv.classList.add('selected'); // 'All' is selected by default
        allCheckboxDiv.innerHTML = `<input type="checkbox" id="rarity-all" value="All" checked><label for="rarity-all">All</label>`;
        allCheckboxDiv.querySelector('input').addEventListener('change', (event) => {
            if (event.target.checked) {
                currentRarityFilter = []; // Clear all others
                document.querySelectorAll('.rarity-checkbox-item input').forEach(cb => {
                    if (cb.id !== 'rarity-all') cb.checked = false;
                });
                document.querySelectorAll('.rarity-checkbox-item').forEach(item => {
                    if (item.querySelector('input').id !== 'rarity-all') item.classList.remove('selected');
                });
                allCheckboxDiv.classList.add('selected');
            } else {
                if (currentRarityFilter.length === 0) { // If 'All' is the only one checked and trying to uncheck
                    event.target.checked = true; // Keep 'All' checked
                    return;
                }
            }
            renderStructures();
        });
        container.appendChild(allCheckboxDiv);
        currentRarityFilter = []; // Start with no specific filters, 'All' implicitly

        uniqueRarities.forEach(rarity => {
            const div = document.createElement('div');
            div.className = `rarity-checkbox-item rarity-${rarity}`;
            div.innerHTML = `<input type="checkbox" id="rarity-${rarity}" value="${rarity}"><label for="rarity-${rarity}">${rarity.charAt(0).toUpperCase() + rarity.slice(1)}</label>`;

            div.querySelector('input').addEventListener('change', (event) => {
                const allCheckbox = document.getElementById('rarity-all');
                const allCheckboxItem = allCheckbox.closest('.rarity-checkbox-item');

                if (event.target.checked) {
                    currentRarityFilter.push(event.target.value);
                    div.classList.add('selected');
                    if (allCheckbox.checked) {
                        allCheckbox.checked = false;
                        allCheckboxItem.classList.remove('selected');
                        currentRarityFilter = currentRarityFilter.filter(r => r !== 'All');
                    }
                } else {
                    currentRarityFilter = currentRarityFilter.filter(r => r !== event.target.value);
                    div.classList.remove('selected');
                    if (currentRarityFilter.length === 0) {
                        allCheckbox.checked = true;
                        allCheckboxItem.classList.add('selected');
                    }
                }
                renderStructures();
            });
            container.appendChild(div);
        });
    }


    function renderStructures() {
        const container = document.getElementById("structures-container");
        container.innerHTML = "";

        let filteredStructures = structuresData.filter(s => {
            const matchesRarity = currentRarityFilter.length === 0 || currentRarityFilter.includes(s.rarity.toLowerCase());
            const matchesSearch = s.name.toLowerCase().includes(currentSearchQuery.toLowerCase());
            return matchesRarity && matchesSearch;
        });

        filteredStructures.sort((a, b) => {
            if (currentSortOrder === 'name-asc') {
                return a.name.localeCompare(b.name);
            } else if (currentSortOrder === 'name-desc') {
                return b.name.localeCompare(a.name);
            } else if (currentSortOrder === 'mps-asc') {
                const mpsA = (a.income * selectedVariant.multiplier * selectedManager.multiplier * globalFriendsBoostMultiplier * globalPremiumMultiplier) / a.cycleTime;
                const mpsB = (b.income * selectedVariant.multiplier * selectedManager.multiplier * globalFriendsBoostMultiplier * globalPremiumMultiplier) / b.cycleTime;
                return mpsA - mpsB;
            } else if (currentSortOrder === 'mps-desc') {
                const mpsA = (a.income * selectedVariant.multiplier * selectedManager.multiplier * globalFriendsBoostMultiplier * globalPremiumMultiplier) / a.cycleTime;
                const mpsB = (b.income * selectedVariant.multiplier * selectedManager.multiplier * globalFriendsBoostMultiplier * globalPremiumMultiplier) / b.cycleTime;
                return mpsB - mpsA;
            } else if (currentSortOrder === 'price-asc') {
                return a.price - b.price;
            } else if (currentSortOrder === 'price-desc') {
                return b.price - a.price;
            }
            return 0;
        });

        filteredStructures.forEach((struc) => {
            const income = struc.income * selectedVariant.multiplier * selectedManager.multiplier * globalFriendsBoostMultiplier * globalPremiumMultiplier;
            const moneyPerSec = (income / struc.cycleTime).toFixed(2);
            const div = document.createElement("div");
            div.className = "structure";
            div.classList.add(`rarity-${struc.rarity.toLowerCase()}`);
            const originalIndex = structuresData.findIndex(s => s.name === struc.name);
            if (originalIndex === selectedStructureIndex) div.classList.add("selected");

            div.innerHTML = `
                <h3>${struc.name}</h3>
                <p class="rarity ${struc.rarity.toLowerCase()}">${struc.rarity}</p>
                <p>Price: ${formatMoney(struc.price)}</p>
                <p>Money/sec: ${moneyPerSec}</p>
            `;
            div.addEventListener("click", () => {
                selectedStructureIndex = originalIndex;
                document.querySelectorAll(".structure").forEach(el => el.classList.remove("selected"));
                div.classList.add("selected");
                updateWiki();
            });
            container.appendChild(div);
        });
    }

    function updateWiki() {
        const container = document.getElementById("wiki-text");
        if (selectedStructureIndex === null) {
            container.innerHTML = `
                <h3>Idle Life Wiki</h3>
                <p>Select a structure from the list above to view detailed information,
                calculated with the currently selected Variant, Manager, and global boosts.</p>
            `;
            return;
        }
        const s = structuresData[selectedStructureIndex];
        const income = s.income * selectedVariant.multiplier * selectedManager.multiplier * globalFriendsBoostMultiplier * globalPremiumMultiplier;
        const mps = (income / s.cycleTime).toFixed(2);
        container.innerHTML = `
            <h3>${s.name} (Variant: ${selectedVariant.name})</h3>
            <p><strong>Price:</strong> ${formatMoney(s.price)}</p>
            <p><strong>Rarity:</strong> <span class="rarity ${s.rarity.toLowerCase()}">${s.rarity}</span></p>
            <p><strong>Money per cycle:</strong> ${formatMoney(income)}</p>
            <p><strong>Cycle time:</strong> ${s.cycleTime} sec</p>
            <p><strong>Money/sec (Current):</strong> ${mps}</p>
            <p><strong>Manager boost:</strong> x${selectedManager.multiplier.toFixed(2)}</p>
            <p><strong>Variant boost:</strong> x${selectedVariant.multiplier.toFixed(2)}</p>
            <p><strong>Friends boost:</strong> x${globalFriendsBoostMultiplier.toFixed(2)} (${((globalFriendsBoostMultiplier - 1) * 100).toFixed(0)}%)</p>
            <p><strong>Premium boost:</strong> x${globalPremiumMultiplier.toFixed(2)} (${((globalPremiumMultiplier - 1) * 100).toFixed(0)}%)</p>
        `;
    }

    // Event Listeners for Filters and Sort
    document.getElementById('sortOrder').addEventListener('change', (event) => {
        currentSortOrder = event.target.value;
        renderStructures();
    });

    document.getElementById('searchStructures').addEventListener('input', (event) => {
        currentSearchQuery = event.target.value;
        renderStructures();
    });

    // Event Listeners for Global Boosts
    document.getElementById('friendsCount').addEventListener('input', updateGlobalBoosts);
    document.getElementById('isPremium').addEventListener('change', updateGlobalBoosts);

    // --- Trade Functions ---

    function populateTradeSelects() {
        [1, 2].forEach((num) => {
            const variantSelect = document.getElementById(`tradeVariant${num}`);
            const managerSelect = document.getElementById(`tradeManager${num}`);
            const structureSelect = document.getElementById(`tradeStructureSelect${num}`);

            // Populate variants
            variantSelect.innerHTML = "";
            variants.forEach(v => {
                const option = document.createElement("option");
                option.value = v.name;
                option.textContent = v.name;
                variantSelect.appendChild(option);
            });
            variantSelect.value = tradeStates[num].variant.name; // Set initial selection
            variantSelect.addEventListener('change', (event) => {
                tradeStates[num].variant = variants.find(v => v.name === event.target.value);
                // No need to call updateTradeStructureList here directly for *each* change
                // as captured multipliers prevent dynamic update after addition.
                // It will update when calculateTrades() is called.
            });

            // Populate managers
            managerSelect.innerHTML = "";
            managers.forEach(m => {
                const option = document.createElement("option");
                option.value = m.name;
                option.textContent = m.name;
                managerSelect.appendChild(option);
            });
            managerSelect.value = tradeStates[num].manager.name; // Set initial selection
            managerSelect.addEventListener('change', (event) => {
                tradeStates[num].manager = managers.find(m => m.name === event.target.value);
                // Same as above, no need to update trade structures list directly.
            });

            // Populate structures (all structures are available to add)
            structureSelect.innerHTML = "";
            structuresData.forEach((str) => {
                const option = document.createElement("option");
                option.value = str.name;
                option.textContent = `${str.name} (${str.rarity})`;
                structureSelect.appendChild(option);
            });
            if (structuresData.length > 0) {
                structureSelect.value = structuresData[0].name;
            }
        });
    }

    function addTradeStructure(tradeNum) {
        const select = document.getElementById(`tradeStructureSelect${tradeNum}`);
        const selectedName = select.value;
        const structure = structuresData.find((s) => s.name === selectedName);

        if (structure) {
            // CAPTURE ALL RELEVANT BOOSTS AT THE MOMENT OF ADDITION
            const capturedFriendsBoost = globalFriendsBoostMultiplier;
            const capturedPremiumBoost = globalPremiumMultiplier;
            const capturedVariantMultiplier = tradeStates[tradeNum].variant.multiplier;
            const capturedManagerMultiplier = tradeStates[tradeNum].manager.multiplier;
            const capturedVariantName = tradeStates[tradeNum].variant.name;
            const capturedManagerName = tradeStates[tradeNum].manager.name;

            // Create a new object for the trade item, including all captured boosts
            const tradeItem = {
                ...structure, // Copy all properties from the base structure
                capturedFriendsBoost: capturedFriendsBoost,
                capturedPremiumBoost: capturedPremiumBoost,
                capturedVariantMultiplier: capturedVariantMultiplier,
                capturedManagerMultiplier: capturedManagerMultiplier,
                capturedVariantName: capturedVariantName,
                capturedManagerName: capturedManagerName
            };

            tradeStates[tradeNum].structures.push(tradeItem);
            updateTradeStructureList(tradeNum);
            select.value = structuresData[0].name; // Reset selection to first item
        }
    }

    window.removeTradeStructure = function(tradeNum, index) { // Make global for onclick
        const container = document.getElementById(`structuresList${tradeNum}`);
        const itemToRemove = container.children[index];

        if (itemToRemove) {
            itemToRemove.classList.add('removing');
            setTimeout(() => {
                tradeStates[tradeNum].structures.splice(index, 1);
                updateTradeStructureList(tradeNum);
            }, 400); // Wait for animation to finish
        }
    }

    function updateTradeStructureList(tradeNum) {
        const container = document.getElementById(`structuresList${tradeNum}`);
        container.innerHTML = "";

        tradeStates[tradeNum].structures.forEach((str, i) => {
            // Calculate effective income using the CAPTURED values
            const effectiveIncome = str.income * str.capturedVariantMultiplier * str.capturedManagerMultiplier * str.capturedFriendsBoost * str.capturedPremiumBoost;
            const effectiveMps = effectiveIncome / str.cycleTime;

            const div = document.createElement("div");
            div.classList.add("structure-item");
            // Display captured variant/manager names for clarity
            div.innerHTML = `
                <span>${str.name} (<span class="trade-item-variant">${str.capturedVariantName}</span> / <span class="trade-item-manager">${str.capturedManagerName}</span>)</span>
                <span>${formatMoney(effectiveMps)}/s</span>
                <button onclick="removeTradeStructure(${tradeNum}, ${i})"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(div);
        });

        const totalMpsDisplay = document.getElementById(`trade${tradeNum}TotalMps`);
        if (totalMpsDisplay) {
            const totalIncomePerSecond = tradeStates[tradeNum].structures.reduce((sum, str) => {
                const effectiveIncome = str.income * str.capturedVariantMultiplier * str.capturedManagerMultiplier * str.capturedFriendsBoost * str.capturedPremiumBoost;
                return sum + (effectiveIncome / str.cycleTime);
            }, 0);
            totalMpsDisplay.textContent = `Total MPS: ${formatMoney(totalIncomePerSecond)}`;
        }
    }

    window.clearTradeStructures = function(tradeNum) { // Make global for onclick
        if (confirm(`Are you sure you want to clear all structures from Trade ${tradeNum}?`)) {
            tradeStates[tradeNum].structures = [];
            updateTradeStructureList(tradeNum);
            document.getElementById("resultBox").textContent = "";
            document.getElementById("tradeChartContainer").style.display = 'none';
        }
    }

    function renderTradeChart(value1, value2) {
        const chartContainer = document.getElementById("tradeChartContainer");
        const chartBars = document.getElementById("chartBars");
        chartBars.innerHTML = '';

        chartContainer.style.display = 'flex'; // Show chart

        const maxValue = Math.max(value1, value2, 1); // Ensure maxValue is at least 1 to avoid division by zero
        const minHeightPercentage = 5; // Minimum height for bars to be visible

        const bar1Height = (value1 / maxValue) * 100;
        const bar2Height = (value2 / maxValue) * 100;

        const bar1 = document.createElement('div');
        bar1.className = 'chart-bar trade1';
        bar1.style.height = `${Math.max(bar1Height, minHeightPercentage)}%`;
        bar1.innerHTML = `<span class="bar-value">${formatMoney(value1)}</span>`;

        const bar2 = document.createElement('div');
        bar2.className = 'chart-bar trade2';
        bar2.style.height = `${Math.max(bar2Height, minHeightPercentage)}%`;
        bar2.innerHTML = `<span class="bar-value">${formatMoney(value2)}</span>`;

        chartBars.appendChild(bar1);
        chartBars.appendChild(bar2);
    }

    window.calculateTrades = function() { // Make global for onclick
        let results = "";
        const allTradesValid = [1, 2].every(tradeNum => {
            if (tradeStates[tradeNum].structures.length === 0) {
                alert(`Please add at least one structure to Trade ${tradeNum}.`);
                return false;
            }
            return true;
        });

        if (!allTradesValid) {
            document.getElementById("resultBox").textContent = "";
            document.getElementById("tradeChartContainer").style.display = 'none';
            return;
        }

        const trade1 = tradeStates[1];
        const trade2 = tradeStates[2];

        const calculateTotalIncomePerSecond = (trade) => {
            let totalIncomePerSecond = 0;
            trade.structures.forEach((str) => {
                const effectiveIncome = str.income * str.capturedVariantMultiplier * str.capturedManagerMultiplier * str.capturedFriendsBoost * str.capturedPremiumBoost;
                totalIncomePerSecond += effectiveIncome / str.cycleTime;
            });
            return totalIncomePerSecond;
        };

        const totalIncomePerSecond1 = calculateTotalIncomePerSecond(trade1);
        const totalIncomePerSecond2 = calculateTotalIncomePerSecond(trade2);

        results += `--- Trade Summary ---\n\n`;

        // Detailed breakdown for Trade 1
        results += `Trade 1 (Variant: ${trade1.variant.name} / Manager: ${trade1.manager.name}):\n`;
        results += `  Structures (${trade1.structures.length} items):\n`;
        trade1.structures.forEach(s => {
            const currentIncome = s.income * s.capturedVariantMultiplier * s.capturedManagerMultiplier * s.capturedFriendsBoost * s.capturedPremiumBoost;
            results += `    - ${s.name} (Rarity: ${s.rarity}, Income: ${formatMoney(currentIncome)}, Cycle: ${s.cycleTime}s, MPS: ${formatMoney(currentIncome / s.cycleTime)})\n`;
            results += `      [Applied Boosts: Variant: x${s.capturedVariantMultiplier.toFixed(2)}, Manager: x${s.capturedManagerMultiplier.toFixed(2)}, Friends: x${s.capturedFriendsBoost.toFixed(2)}, Premium: x${s.capturedPremiumBoost.toFixed(2)}]\n`;
        });
        results += `  Total Income per Second: ${formatMoney(totalIncomePerSecond1)}\n\n`;

        // Detailed breakdown for Trade 2
        results += `Trade 2 (Variant: ${trade2.variant.name} / Manager: ${trade2.manager.name}):\n`;
        results += `  Structures (${trade2.structures.length} items):\n`;
        trade2.structures.forEach(s => {
            const currentIncome = s.income * s.capturedVariantMultiplier * s.capturedManagerMultiplier * s.capturedFriendsBoost * s.capturedPremiumBoost;
            results += `    - ${s.name} (Rarity: ${s.rarity}, Income: ${formatMoney(currentIncome)}, Cycle: ${s.cycleTime}s, MPS: ${formatMoney(currentIncome / s.cycleTime)})\n`;
            results += `      [Applied Boosts: Variant: x${s.capturedVariantMultiplier.toFixed(2)}, Manager: x${s.capturedManagerMultiplier.toFixed(2)}, Friends: x${s.capturedFriendsBoost.toFixed(2)}, Premium: x${s.capturedPremiumBoost.toFixed(2)}]\n`;
        });
        results += `  Total Income per Second: ${formatMoney(totalIncomePerSecond2)}\n\n`;

        results += `--- Comparison ---\n`;
        if (totalIncomePerSecond1 > totalIncomePerSecond2) {
            const diff = totalIncomePerSecond1 - totalIncomePerSecond2;
            const percentageDiff = (diff / totalIncomePerSecond2) * 100;
            results += `Trade 1 is better by ${formatMoney(diff)} money/sec! (${percentageDiff.toFixed(2)}% increase)\n`;
        } else if (totalIncomePerSecond2 > totalIncomePerSecond1) {
            const diff = totalIncomePerSecond2 - totalIncomePerSecond1;
            const percentageDiff = (diff / totalIncomePerSecond1) * 100;
            results += `Trade 2 is better by ${formatMoney(diff)} money/sec! (${percentageDiff.toFixed(2)}% increase)\n`;
        } else {
            results += `Both trades have the same income per second!\n`;
        }

        document.getElementById("resultBox").textContent = results;
        renderTradeChart(totalIncomePerSecond1, totalIncomePerSecond2);
    }

    // Initialize everything on page load
    document.addEventListener("DOMContentLoaded", () => {
        renderVariants();
        renderManagers();
        renderRarityFilters();
        updateGlobalBoosts();
        renderStructures();
        updateWiki();
        populateTradeSelects();
        updateTradeStructureList(1);
        updateTradeStructureList(2);
    });

    </script>
</body>
</html>
